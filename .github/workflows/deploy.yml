name: Deploy Zava to Azure

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      deployment_type:
        description: 'Deployment type'
        required: true
        default: 'container-apps'
        type: choice
        options:
          - container-apps
          - app-services

env:
  AZURE_REGION: 'East US 2'
  DOTNET_VERSION: '9.0.x'

jobs:
  # Determine environment and deployment type
  setup:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.determine-env.outputs.environment }}
      deployment-type: ${{ steps.determine-env.outputs.deployment-type }}
      should-deploy: ${{ steps.determine-env.outputs.should-deploy }}
    steps:
      - name: Determine environment and deployment type
        id: determine-env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "deployment-type=${{ inputs.deployment_type }}" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "deployment-type=container-apps" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "deployment-type=container-apps" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "deployment-type=container-apps" >> $GITHUB_OUTPUT
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  # Build and test
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install .NET 9 SDK (if needed)
        run: |
          if [ -f "src/dotnet-install.sh" ]; then
            chmod +x src/dotnet-install.sh
            ./src/dotnet-install.sh --version 9.0.101 --install-dir ~/.dotnet --no-path
            export PATH="$HOME/.dotnet:$PATH"
          fi

      - name: Restore dependencies
        run: |
          export PATH="$HOME/.dotnet:$PATH"
          cd src
          dotnet restore ZavaAppHost/ZavaAppHost.csproj
          dotnet restore Products/Products.csproj
          dotnet restore Search/Search.csproj
          dotnet restore Chat/Chat.csproj
          dotnet restore Store/Store.csproj

      - name: Build solution
        run: |
          export PATH="$HOME/.dotnet:$PATH"
          cd src
          dotnet build ZavaAppHost/ZavaAppHost.csproj --no-restore --configuration Release
          dotnet build Products/Products.csproj --no-restore --configuration Release
          dotnet build Search/Search.csproj --no-restore --configuration Release
          dotnet build Chat/Chat.csproj --no-restore --configuration Release
          dotnet build Store/Store.csproj --no-restore --configuration Release

      - name: Run tests
        run: |
          export PATH="$HOME/.dotnet:$PATH"
          cd src
          dotnet test Products.Tests/Products.Tests.csproj --no-build --configuration Release --verbosity normal
          dotnet test Search.Tests/Search.Tests.csproj --no-build --configuration Release --verbosity normal
          dotnet test Store.Tests/Store.Tests.csproj --no-build --configuration Release --verbosity normal

      - name: Publish applications
        run: |
          export PATH="$HOME/.dotnet:$PATH"
          cd src
          dotnet publish Products/Products.csproj --no-build --configuration Release --output ./publish/products
          dotnet publish Search/Search.csproj --no-build --configuration Release --output ./publish/search
          dotnet publish Chat/Chat.csproj --no-build --configuration Release --output ./publish/chat
          dotnet publish Store/Store.csproj --no-build --configuration Release --output ./publish/store

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: published-apps
          path: src/publish/
          retention-days: 30

  # Build Docker images
  build-images:
    runs-on: ubuntu-latest
    needs: [setup, build-and-test]
    if: needs.setup.outputs.should-deploy == 'true'
    strategy:
      matrix:
        service: [products, search, chat, store]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: published-apps
          path: src/publish/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create Dockerfile for ${{ matrix.service }}
        run: |
          mkdir -p dockerfiles
          cat > dockerfiles/Dockerfile.${{ matrix.service }} << EOF
          FROM mcr.microsoft.com/dotnet/aspnet:9.0
          WORKDIR /app
          COPY src/publish/${{ matrix.service }}/ .
          EXPOSE 8080
          ENTRYPOINT ["dotnet", "${{ matrix.service == 'products' && 'Products.dll' || matrix.service == 'search' && 'Search.dll' || matrix.service == 'chat' && 'Chat.dll' || 'Store.dll' }}"]
          EOF

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: dockerfiles/Dockerfile.${{ matrix.service }}
          tags: |
            zava/${{ matrix.service }}:latest
            zava/${{ matrix.service }}:${{ github.sha }}
          outputs: type=docker,dest=/tmp/${{ matrix.service }}-image.tar

      - name: Upload Docker image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ matrix.service }}
          path: /tmp/${{ matrix.service }}-image.tar
          retention-days: 7

  # Deploy infrastructure
  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: [setup, build-and-test]
    if: needs.setup.outputs.should-deploy == 'true'
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      resource-group-name: ${{ steps.deploy.outputs.resourceGroupName }}
      container-registry-name: ${{ steps.deploy.outputs.containerRegistryName }}
      store-app-url: ${{ steps.deploy.outputs.storeAppUrl }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group
        run: |
          az group create \
            --name "rg-zava-${{ needs.setup.outputs.environment }}" \
            --location "${{ env.AZURE_REGION }}" \
            --tags environment=${{ needs.setup.outputs.environment }} application=zava

      - name: Deploy BICEP template
        id: deploy
        run: |
          TEMPLATE_FILE="infrastructure/bicep/main-${{ needs.setup.outputs.deployment-type }}.bicep"
          PARAMETERS_FILE="infrastructure/parameters/${{ needs.setup.outputs.environment }}.json"
          
          # Deploy infrastructure
          az deployment group create \
            --resource-group "rg-zava-${{ needs.setup.outputs.environment }}" \
            --template-file "$TEMPLATE_FILE" \
            --parameters "@$PARAMETERS_FILE" \
            --parameters nlWebApiKey="${{ secrets.NLWEB_API_KEY }}" \
            --parameters sqlAdminPassword="${{ secrets.SQL_ADMIN_PASSWORD }}" \
            --output json > deployment-output.json

          # Extract outputs
          echo "resourceGroupName=$(jq -r '.properties.outputs.resourceGroupName.value' deployment-output.json)" >> $GITHUB_OUTPUT
          echo "containerRegistryName=$(jq -r '.properties.outputs.containerRegistryName.value' deployment-output.json)" >> $GITHUB_OUTPUT
          echo "storeAppUrl=$(jq -r '.properties.outputs.storeAppUrl.value' deployment-output.json)" >> $GITHUB_OUTPUT

      - name: Upload deployment outputs
        uses: actions/upload-artifact@v4
        with:
          name: deployment-outputs
          path: deployment-output.json
          retention-days: 7

  # Deploy applications
  deploy-applications:
    runs-on: ubuntu-latest
    needs: [setup, build-images, deploy-infrastructure]
    if: needs.setup.outputs.should-deploy == 'true'
    environment: ${{ needs.setup.outputs.environment }}
    strategy:
      matrix:
        service: [products, search, chat, store]
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ matrix.service }}
          path: /tmp/

      - name: Load and push Docker image
        run: |
          # Load image
          docker load --input /tmp/${{ matrix.service }}-image.tar
          
          # Get ACR login server
          ACR_NAME="${{ needs.deploy-infrastructure.outputs.container-registry-name }}"
          ACR_SERVER=$(az acr show --name $ACR_NAME --query loginServer --output tsv)
          
          # Login to ACR
          az acr login --name $ACR_NAME
          
          # Tag and push image
          docker tag zava/${{ matrix.service }}:latest $ACR_SERVER/zava/${{ matrix.service }}:latest
          docker tag zava/${{ matrix.service }}:latest $ACR_SERVER/zava/${{ matrix.service }}:${{ github.sha }}
          
          docker push $ACR_SERVER/zava/${{ matrix.service }}:latest
          docker push $ACR_SERVER/zava/${{ matrix.service }}:${{ github.sha }}

      - name: Update Container App (if using Container Apps)
        if: needs.setup.outputs.deployment-type == 'container-apps'
        run: |
          ACR_NAME="${{ needs.deploy-infrastructure.outputs.container-registry-name }}"
          ACR_SERVER=$(az acr show --name $ACR_NAME --query loginServer --output tsv)
          
          az containerapp update \
            --name "zava-${{ needs.setup.outputs.environment }}-${{ matrix.service }}" \
            --resource-group "${{ needs.deploy-infrastructure.outputs.resource-group-name }}" \
            --image "$ACR_SERVER/zava/${{ matrix.service }}:${{ github.sha }}"

      - name: Update App Service (if using App Services)
        if: needs.setup.outputs.deployment-type == 'app-services'
        run: |
          ACR_NAME="${{ needs.deploy-infrastructure.outputs.container-registry-name }}"
          ACR_SERVER=$(az acr show --name $ACR_NAME --query loginServer --output tsv)
          
          az webapp config container set \
            --name "zava-${{ needs.setup.outputs.environment }}-${{ matrix.service }}" \
            --resource-group "${{ needs.deploy-infrastructure.outputs.resource-group-name }}" \
            --docker-custom-image-name "$ACR_SERVER/zava/${{ matrix.service }}:${{ github.sha }}" \
            --docker-registry-server-url "https://$ACR_SERVER"

  # Run deployment tests
  deployment-tests:
    runs-on: ubuntu-latest
    needs: [setup, deploy-infrastructure, deploy-applications]
    if: needs.setup.outputs.should-deploy == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for application startup
        run: sleep 60

      - name: Test Store application
        run: |
          STORE_URL="${{ needs.deploy-infrastructure.outputs.store-app-url }}"
          
          # Test home page
          response=$(curl -s -o /dev/null -w "%{http_code}" "$STORE_URL")
          if [ $response -eq 200 ]; then
            echo "âœ… Store home page is accessible"
          else
            echo "âŒ Store home page returned $response"
            exit 1
          fi
          
          # Test health endpoint
          response=$(curl -s -o /dev/null -w "%{http_code}" "$STORE_URL/health")
          if [ $response -eq 200 ]; then
            echo "âœ… Store health endpoint is healthy"
          else
            echo "âŒ Store health endpoint returned $response"
            exit 1
          fi

      - name: Test API endpoints
        run: |
          STORE_URL="${{ needs.deploy-infrastructure.outputs.store-app-url }}"
          BASE_URL="${STORE_URL%/*}"  # Remove trailing path
          
          # Test search API
          response=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/search/health")
          if [ $response -eq 200 ]; then
            echo "âœ… Search API health endpoint is healthy"
          else
            echo "âš ï¸  Search API health endpoint returned $response (may not be externally accessible)"
          fi
          
          # Test chat API
          response=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/chat/health")
          if [ $response -eq 200 ]; then
            echo "âœ… Chat API health endpoint is healthy"
          else
            echo "âš ï¸  Chat API health endpoint returned $response (may not be externally accessible)"
          fi

  # Send deployment notification
  notify:
    runs-on: ubuntu-latest
    needs: [setup, deploy-infrastructure, deployment-tests]
    if: always() && needs.setup.outputs.should-deploy == 'true'
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Type**: ${{ needs.setup.outputs.deployment-type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Store URL**: ${{ needs.deploy-infrastructure.outputs.store-app-url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Key Features Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Zava Store with enhanced UI" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AI Chat Assistant with real-time messaging" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… NLWeb-powered search functionality" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Products API with full catalog" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Application Insights monitoring" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Azure Key Vault for secrets management" >> $GITHUB_STEP_SUMMARY