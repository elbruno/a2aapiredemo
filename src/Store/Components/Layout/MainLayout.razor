@using Store.Components.Cart
@using Store.Components.Chat
@inject NavigationManager NavigationManager
@inherits LayoutComponentBase

<div class="page">
    <div class="sidebar">
        <NavMenu OnToggleCart="ToggleCart" />
    </div>

    <main>
        <div class="top-row px-4 d-flex justify-content-between align-items-center">
            <!-- Search box -->
            <div class="search-box d-flex flex-grow-1 me-3">
                <div class="input-group" style="max-width: 400px;">
                    <input type="text" class="form-control" @bind="searchQuery" @onkeypress="OnSearchKeyPress" placeholder="Search products and content..." />
                    <button class="btn btn-outline-secondary" type="button" @onclick="PerformSearch">
                        <span class="bi bi-search" aria-hidden="true"></span>
                    </button>
                </div>
            </div>
            
            <!-- Source code link -->
            <div class="source-link">
                <a href="https://aka.ms/eshoplite/repo" target="_blank">Source Code</a>
            </div>
        </div>

        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

<CartOffcanvas IsVisible="isCartVisible" IsVisibleChanged="OnCartVisibilityChanged" OnCartUpdated="OnCartUpdated" />

<!-- Chat Widget -->
<ChatWidget @rendermode="InteractiveServer" />

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">🗙</a>
</div>

@code {
    private bool isCartVisible = false;
    private string searchQuery = "";

    private Task ToggleCart()
    {
        isCartVisible = !isCartVisible;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task OnCartVisibilityChanged(bool visible)
    {
        isCartVisible = visible;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task OnCartUpdated()
    {
        // This can be used to refresh cart count or show notifications
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void PerformSearch()
    {
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            var navigation = NavigationManager;
            var encodedQuery = Uri.EscapeDataString(searchQuery.Trim());
            navigation.NavigateTo($"/search?q={encodedQuery}");
        }
    }

    private async Task OnSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            PerformSearch();
        }
    }
}
