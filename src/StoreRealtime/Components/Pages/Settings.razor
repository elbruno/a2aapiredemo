@page "/settings"
@using StoreRealtime.Services
@using DataSources.Models
@using System.Linq
@inject DataSourcesService DataSourcesService
@inject ILogger<Settings> Logger
@attribute [StreamRendering(true)]
@rendermode InteractiveServer

<PageTitle>Settings - Web Page Indexing</PageTitle>

<h1>Settings</h1>
<p>Configure web pages for enhanced search and chat functionality.</p>

<div class="container">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4>Index Web Pages</h4>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Add up to 5 URLs to index their content for semantic search. The AI chat will be able to
                        reference information from these pages.
                    </p>

                    <EditForm Model="@indexRequest" OnValidSubmit="@IndexUrls">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="alert alert-danger" />

                        <div class="mb-3">
                            <label class="form-label">Web Page URLs (1-5 URLs)</label>
                            @for (int i = 0; i < 5; i++)
                            {
                                var index = i; // Capture for closure
                                               <div class="input-group mb-2">
                                                   <span class="input-group-text">@(index + 1)</span>
                                                   <!-- Bind directly to the EditForm model so validation works -->
                                                   <input type="url" class="form-control" @bind="indexRequest.Urls[index]"
                                                       placeholder="https://example.com/article" disabled="@isIndexing" />
                                               </div>
                            }
                            <small class="form-text text-muted">
                                Enter valid HTTP/HTTPS URLs. Empty fields will be ignored.
                            </small>
                        </div>

                        <button type="submit" class="btn btn-primary me-2" disabled="@(isIndexing || !HasValidUrls())">
                            @if (isIndexing)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span>Indexing...</span>
                            }
                            else
                            {
                                <i class="bi bi-cloud-upload me-2"></i>
                                <span>Index Web Pages</span>
                            }
                        </button>
                        <button type="button" class="btn btn-secondary" disabled="@isIndexing"
                            @onclick="SetDefaultValues">
                            <i class="bi bi-gear-fill me-2"></i>
                            <span>Set Default Values</span>
                        </button>
                    </EditForm>

                    @if (!string.IsNullOrEmpty(statusMessage))
                    {
                        <div class="alert @(isError ? "alert-danger" : "alert-success") mt-3">
                            @statusMessage
                        </div>
                    }

                    @if (indexingResults.Any())
                    {
                        <div class="mt-4">
                            <h5>Indexing Results</h5>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>URL</th>
                                            <th>Title</th>
                                            <th>Chunks</th>
                                            <th>Status</th>
                                            <th>Indexed At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var result in indexingResults)
                                        {
                                            <tr class="@(result.Success ? "" : "table-danger")">
                                                <td>
                                                    <a href="@result.Url" target="_blank" class="text-truncate"
                                                        style="max-width: 200px; display: inline-block;">
                                                        @result.Url
                                                    </a>
                                                </td>
                                                <td>@result.Title</td>
                                                <td>@result.ChunkCount</td>
                                                <td>
                                                    @if (result.Success)
                                                    {
                                                        <span class="badge bg-success">Success</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-danger" title="@result.ErrorMessage">Failed</span>
                                                    }
                                                </td>
                                                <td>@result.IndexedAt.ToString("MM/dd HH:mm")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Currently Indexed Pages</h5>
                </div>
                <div class="card-body">
                    @if (currentIndexedUrls == null)
                    {
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <span class="ms-2">Loading...</span>
                        </div>
                    }
                    else if (!currentIndexedUrls.Any())
                    {
                        <p class="text-muted">No pages indexed yet.</p>
                    }
                    else
                    {
                        @foreach (var indexedUrl in currentIndexedUrls)
                        {
                            <div class="card mb-2 border-0 bg-light">
                                <div class="card-body p-2">
                                    <h6 class="card-title mb-1 text-truncate">@indexedUrl.Title</h6>
                                    <p class="card-text small text-muted mb-1">
                                        <a href="@indexedUrl.Url" target="_blank" class="text-decoration-none">
                                            @GetDomainFromUrl(indexedUrl.Url)
                                        </a>
                                    </p>
                                    <small class="text-muted">
                                        @indexedUrl.ChunkCount chunks â€¢ @indexedUrl.IndexedAt.ToString("MM/dd HH:mm")
                                    </small>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h6>How it works</h6>
                </div>
                <div class="card-body">
                    <ol class="small">
                        <li>Enter web page URLs you want to reference</li>
                        <li>The system crawls and extracts main content</li>
                        <li>Content is chunked and embedded for search</li>
                        <li>AI chat can now reference this information</li>
                        <li>Use the search page to find relevant content</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // Ensure the model has 5 slots immediately so the Razor for-loop can safely bind to indexes 0..4
    private IndexUrlsRequest indexRequest = new() { Urls = Enumerable.Range(0, 5).Select(_ => string.Empty).ToList() };
    private bool isIndexing = false;
    private string statusMessage = "";
    private bool isError = false;
    private List<IndexedUrl> indexingResults = new();
    private List<IndexedUrl>? currentIndexedUrls = null;

    protected override async Task OnInitializedAsync()
    {
        // Initialize the model with 5 empty URL slots so the inputs bind
        // directly to the model and EditForm validation reflects user input.
        if (indexRequest.Urls == null || indexRequest.Urls.Count < 5)
        {
            indexRequest.Urls = Enumerable.Range(0, 5).Select(_ => string.Empty).ToList();
        }

        // Load currently indexed URLs
        await LoadIndexedUrls();
    }

    private async Task LoadIndexedUrls()
    {
        try
        {
            currentIndexedUrls = await DataSourcesService.GetIndexedUrlsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading indexed URLs");
            currentIndexedUrls = new List<IndexedUrl>();
        }
    }

    private bool HasValidUrls()
    {
        return indexRequest.Urls != null && indexRequest.Urls.Any(url => !string.IsNullOrWhiteSpace(url) && Uri.TryCreate(url,
        UriKind.Absolute, out _));
    }

    private async Task IndexUrls()
    {
        isIndexing = true;
        statusMessage = "";
        isError = false;
        indexingResults.Clear();

        try
        {
            // Get non-empty URLs from the model
            var validUrls = indexRequest.Urls?.Where(url => !string.IsNullOrWhiteSpace(url)).ToList() ?? new List<string>();

            if (!validUrls.Any())
            {
                statusMessage = "Please enter at least one valid URL.";
                isError = true;
                return;
            }

            // Create a request copy with only the valid URLs so we don't shrink the UI-bound model
            var requestForApi = new IndexUrlsRequest { Urls = validUrls };

            Logger.LogInformation("Indexing {Count} URLs", validUrls.Count);

            var response = await DataSourcesService.IndexUrlsAsync(requestForApi);

            if (response != null)
            {
                indexingResults = response.IndexedUrls;

                var successCount = response.IndexedUrls.Count(u => u.Success);
                var errorCount = response.IndexedUrls.Count - successCount;

                if (errorCount == 0)
                {
                    statusMessage = $"Successfully indexed {successCount} web page(s)!";
                    isError = false;

                    // Clear the form by resetting 5 empty slots on the UI-bound model
                    indexRequest.Urls = Enumerable.Range(0, 5).Select(_ => string.Empty).ToList();
                }
                else
                {
                    statusMessage = $"Indexed {successCount} page(s) successfully, {errorCount} failed. Check details below.";
                    isError = errorCount > successCount;
                }

                // Add errors if any
                if (response.Errors.Any())
                {
                    statusMessage += $" Errors: {string.Join(", ", response.Errors)}";
                }

                // Refresh the indexed URLs list
                await LoadIndexedUrls();
            }
            else
            {
                statusMessage = "Failed to index URLs. Please try again.";
                isError = true;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error indexing URLs");
            statusMessage = $"An error occurred: {ex.Message}";
            isError = true;
        }
        finally
        {
            isIndexing = false;
        }
    }

    private string GetDomainFromUrl(string url)
    {
        try
        {
            var uri = new Uri(url);
            return uri.Host;
        }
        catch
        {
            return url;
        }
    }

    private void SetDefaultValues()
    {
        // Populate the first three slots with recommended defaults and clear the remaining two
        var defaults = new[]
        {
"https://learn.microsoft.com/en-us/azure/ai-foundry/openai/whats-new#realtime-api-audio-model-ga",
"https://learn.microsoft.com/en-us/azure/ai-foundry/how-to/develop/sdk-overview?pivots=programming-language-csharp",
"https://devblogs.microsoft.com/dotnet/dotnet-10-rc-1/"
};

        for (int i = 0; i < 5; i++)
        {
            indexRequest.Urls[i] = i < defaults.Length ? defaults[i] : string.Empty;
        }
    }
}