@page "/settings"
@using StoreRealtime.Services
@using DataSources.Models
@using System.Linq
@inject DataSourcesService DataSourcesService
@inject ISystemPromptService SystemPromptService
@inject ILogger<Settings> Logger
@attribute [StreamRendering(true)]
@rendermode InteractiveServer

<PageTitle>Settings - Web Page Indexing & AI Configuration</PageTitle>

<div class="modern-settings-container">
    <div class="settings-header">
        <h1>‚öôÔ∏è Settings</h1>
        <p>Configure web pages for enhanced search and AI assistant behavior.</p>
    </div>

    <div class="settings-content">
        <div class="settings-grid">
            <!-- System Prompt Configuration -->
            <div class="settings-card">
                <div class="card-header">
                    <h4>ü§ñ AI Assistant Configuration</h4>
                    <p class="card-description">Customize your AI assistant's behavior and personality</p>
                </div>
                <div class="card-body">
                    <EditForm Model="@systemPromptModel" OnValidSubmit="@UpdateSystemPrompt">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="validation-summary" />

                        <div class="form-group">
                            <label class="form-label">
                                System Prompt
                                <span class="required">*</span>
                            </label>
                            <textarea class="form-control large-textarea" 
                                     @bind="systemPromptModel.Prompt"
                                     placeholder="Enter your custom system prompt here..."
                                     rows="6"
                                     disabled="@isUpdatingPrompt"></textarea>
                            <small class="form-text">
                                This prompt defines how your AI assistant behaves and responds. Use {0} to include the current date.
                            </small>
                            
                            @if (!string.IsNullOrEmpty(systemPromptModel.Prompt))
                            {
                                <div class="preview-section">
                                    <label class="form-label">Preview (with current date):</label>
                                    <div class="prompt-preview">@systemPromptModel.DisplayPrompt</div>
                                </div>
                            }
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="modern-btn btn-primary" disabled="@isUpdatingPrompt">
                                @if (isUpdatingPrompt)
                                {
                                    <span class="spinner-sm"></span>
                                    <span>Updating...</span>
                                }
                                else
                                {
                                    <span class="btn-icon">üíæ</span>
                                    <span>Update System Prompt</span>
                                }
                            </button>
                            <button type="button" class="modern-btn btn-secondary" 
                                    @onclick="ResetToDefault" disabled="@isUpdatingPrompt">
                                <span class="btn-icon">üîÑ</span>
                                <span>Reset to Default</span>
                            </button>
                        </div>
                    </EditForm>

                    @if (!string.IsNullOrEmpty(promptStatusMessage))
                    {
                        <div class="alert @(promptIsError ? "alert-error" : "alert-success")">
                            @promptStatusMessage
                        </div>
                    }
                </div>
            </div>

            <!-- Web Page Indexing -->
            <div class="settings-card">
                <div class="card-header">
                    <h4>üìÑ Web Page Indexing</h4>
                    <p class="card-description">Add web pages to enhance AI responses with external content</p>
                </div>
                <div class="card-body">
                    <EditForm Model="@indexRequest" OnValidSubmit="@IndexUrls">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="validation-summary" />

                        <div class="form-group">
                            <label class="form-label">Web Page URLs (1-5 URLs)</label>
                            @for (int i = 0; i < 5; i++)
                            {
                                var index = i;
                                <div class="input-group">
                                    <span class="input-group-text">@(index + 1)</span>
                                    <input type="url" class="form-control" @bind="indexRequest.Urls[index]"
                                           placeholder="https://example.com/article" disabled="@isIndexing" />
                                </div>
                            }
                            <small class="form-text">
                                Enter valid HTTP/HTTPS URLs. Empty fields will be ignored.
                            </small>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="modern-btn btn-primary" disabled="@(isIndexing || !HasValidUrls())">
                                @if (isIndexing)
                                {
                                    <span class="spinner-sm"></span>
                                    <span>Indexing...</span>
                                }
                                else
                                {
                                    <span class="btn-icon">üîó</span>
                                    <span>Index Web Pages</span>
                                }
                            </button>
                            <button type="button" class="modern-btn btn-secondary" disabled="@isIndexing"
                                    @onclick="SetDefaultValues">
                                <span class="btn-icon">‚≠ê</span>
                                <span>Use Examples</span>
                            </button>
                        </div>
                    </EditForm>

                    @if (!string.IsNullOrEmpty(statusMessage))
                    {
                        <div class="alert @(isError ? "alert-error" : "alert-success")">
                            @statusMessage
                        </div>
                    }

                    @if (indexingResults.Any())
                    {
                        <div class="results-section">
                            <h5>Indexing Results</h5>
                            <div class="results-grid">
                                @foreach (var result in indexingResults)
                                {
                                    <div class="result-card @(result.Success ? "success" : "error")">
                                        <div class="result-header">
                                            <h6 class="result-title">@result.Title</h6>
                                            <span class="result-status @(result.Success ? "success" : "error")">
                                                @(result.Success ? "‚úÖ" : "‚ùå")
                                            </span>
                                        </div>
                                        <div class="result-content">
                                            <a href="@result.Url" target="_blank" class="result-url">@GetDomainFromUrl(result.Url)</a>
                                            <div class="result-meta">
                                                <span class="chunk-count">@result.ChunkCount chunks</span>
                                                <span class="index-date">@result.IndexedAt.ToString("MMM dd, HH:mm")</span>
                                            </div>
                                            @if (!result.Success && !string.IsNullOrEmpty(result.ErrorMessage))
                                            {
                                                <div class="error-message">@result.ErrorMessage</div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="settings-sidebar">
            <div class="sidebar-card">
                <div class="card-header">
                    <h5>üìö Currently Indexed Pages</h5>
                </div>
                <div class="card-body">
                    @if (currentIndexedUrls == null)
                    {
                        <div class="loading-state">
                            <div class="spinner-sm"></div>
                            <span>Loading...</span>
                        </div>
                    }
                    else if (!currentIndexedUrls.Any())
                    {
                        <div class="empty-state">
                            <span class="empty-icon">üìÑ</span>
                            <p>No pages indexed yet.</p>
                        </div>
                    }
                    else
                    {
                        <div class="indexed-pages">
                            @foreach (var indexedUrl in currentIndexedUrls)
                            {
                                <div class="indexed-page-card">
                                    <h6 class="page-title">@indexedUrl.Title</h6>
                                    <a href="@indexedUrl.Url" target="_blank" class="page-url">
                                        @GetDomainFromUrl(indexedUrl.Url)
                                    </a>
                                    <div class="page-meta">
                                        <span class="chunk-count">@indexedUrl.ChunkCount chunks</span>
                                        <span class="index-date">@indexedUrl.IndexedAt.ToString("MMM dd")</span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <div class="sidebar-card">
                <div class="card-header">
                    <h6>üí° Quick Tips</h6>
                </div>
                <div class="card-body">
                    <div class="tips-list">
                        <div class="tip-item">
                            <span class="tip-icon">ü§ñ</span>
                            <span>Customize your AI's personality with system prompts</span>
                        </div>
                        <div class="tip-item">
                            <span class="tip-icon">üìÑ</span>
                            <span>Index web pages for richer AI responses</span>
                        </div>
                        <div class="tip-item">
                            <span class="tip-icon">üîç</span>
                            <span>Use high-quality, content-rich pages for best results</span>
                        </div>
                        <div class="tip-item">
                            <span class="tip-icon">üí¨</span>
                            <span>Changes apply to new conversations</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="css/modern-settings.css" />

@code {
    // Web Page Indexing properties
    private IndexUrlsRequest indexRequest = new() { Urls = Enumerable.Range(0, 5).Select(_ => string.Empty).ToList() };
    private bool isIndexing = false;
    private string statusMessage = "";
    private bool isError = false;
    private List<IndexedUrl> indexingResults = new();
    private List<IndexedUrl>? currentIndexedUrls = null;

    // System Prompt properties
    private SystemPromptModel systemPromptModel = new();
    private bool isUpdatingPrompt = false;
    private string promptStatusMessage = "";
    private bool promptIsError = false;

    protected override async Task OnInitializedAsync()
    {
        // Initialize web page indexing model
        if (indexRequest.Urls == null || indexRequest.Urls.Count < 5)
        {
            indexRequest.Urls = Enumerable.Range(0, 5).Select(_ => string.Empty).ToList();
        }

        // Initialize system prompt model
        systemPromptModel.Prompt = SystemPromptService.GetCurrentPrompt();

        // Load currently indexed URLs
        await LoadIndexedUrls();
    }

    #region System Prompt Methods

    private async Task UpdateSystemPrompt()
    {
        isUpdatingPrompt = true;
        promptStatusMessage = "";
        promptIsError = false;

        try
        {
            SystemPromptService.SetPrompt(systemPromptModel.Prompt);
            promptStatusMessage = "System prompt updated successfully! Changes will apply to new conversations.";
            promptIsError = false;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating system prompt");
            promptStatusMessage = $"Failed to update system prompt: {ex.Message}";
            promptIsError = true;
        }
        finally
        {
            isUpdatingPrompt = false;
        }
    }

    private void ResetToDefault()
    {
        systemPromptModel.Prompt = SystemPromptService.GetDefaultPrompt();
        promptStatusMessage = "";
    }

    #endregion

    #region Web Page Indexing Methods

    private async Task LoadIndexedUrls()
    {
        try
        {
            currentIndexedUrls = await DataSourcesService.GetIndexedUrlsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading indexed URLs");
            currentIndexedUrls = new List<IndexedUrl>();
        }
    }

    private bool HasValidUrls()
    {
        return indexRequest.Urls != null && indexRequest.Urls.Any(url => !string.IsNullOrWhiteSpace(url) && Uri.TryCreate(url,
        UriKind.Absolute, out _));
    }

    private async Task IndexUrls()
    {
        isIndexing = true;
        statusMessage = "";
        isError = false;
        indexingResults.Clear();

        try
        {
            // Get non-empty URLs from the model
            var validUrls = indexRequest.Urls?.Where(url => !string.IsNullOrWhiteSpace(url)).ToList() ?? new List<string>();

            if (!validUrls.Any())
            {
                statusMessage = "Please enter at least one valid URL.";
                isError = true;
                return;
            }

            // Create a request copy with only the valid URLs so we don't shrink the UI-bound model
            var requestForApi = new IndexUrlsRequest { Urls = validUrls };

            Logger.LogInformation("Indexing {Count} URLs", validUrls.Count);

            var response = await DataSourcesService.IndexUrlsAsync(requestForApi);

            if (response != null)
            {
                indexingResults = response.IndexedUrls;

                var successCount = response.IndexedUrls.Count(u => u.Success);
                var errorCount = response.IndexedUrls.Count - successCount;

                if (errorCount == 0)
                {
                    statusMessage = $"Successfully indexed {successCount} web page(s)!";
                    isError = false;

                    // Clear the form by resetting 5 empty slots on the UI-bound model
                    indexRequest.Urls = Enumerable.Range(0, 5).Select(_ => string.Empty).ToList();
                }
                else
                {
                    statusMessage = $"Indexed {successCount} page(s) successfully, {errorCount} failed. Check details below.";
                    isError = errorCount > successCount;
                }

                // Add errors if any
                if (response.Errors.Any())
                {
                    statusMessage += $" Errors: {string.Join(", ", response.Errors)}";
                }

                // Refresh the indexed URLs list
                await LoadIndexedUrls();
            }
            else
            {
                statusMessage = "Failed to index URLs. Please try again.";
                isError = true;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error indexing URLs");
            statusMessage = $"An error occurred: {ex.Message}";
            isError = true;
        }
        finally
        {
            isIndexing = false;
        }
    }

    private string GetDomainFromUrl(string url)
    {
        try
        {
            var uri = new Uri(url);
            return uri.Host;
        }
        catch
        {
            return url;
        }
    }

    private void SetDefaultValues()
    {
        // Populate the first three slots with recommended defaults and clear the remaining two
        var defaults = new[]
        {
"https://learn.microsoft.com/en-us/azure/ai-foundry/openai/whats-new#realtime-api-audio-model-ga",
"https://learn.microsoft.com/en-us/azure/ai-foundry/how-to/develop/sdk-overview?pivots=programming-language-csharp",
"https://devblogs.microsoft.com/dotnet/dotnet-10-rc-1/"
};

        for (int i = 0; i < 5; i++)
        {
            indexRequest.Urls[i] = i < defaults.Length ? defaults[i] : string.Empty;
        }
    }

    #endregion
}