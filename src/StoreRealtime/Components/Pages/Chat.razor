@page "/chat"
@using DataEntities
@using SearchEntities
@using OpenAI.Chat
@using System.IO.Pipelines
@using OpenAI.Realtime
@using StoreRealtime.ContextManagers
@using StoreRealtime.Models
@using StoreRealtime.Services
@implements IDisposable

@inject RealtimeClient RealtimeClient
@inject StoreRealtime.ContextManagers.ContosoProductContext contosoProductContext
@inject StoreRealtime.ContextManagers.DataSourcesUrlContext dataSourcesUrlContext
@inject ILogger<Program> logger
@inject IJSRuntime JSRuntime
@inject IJSRuntime JS
@inject SystemPromptService SystemPromptService

<PageTitle>Zava - Modern AI Chat</PageTitle>

@if (isMicActive)
{
    <Microphone OnMicAvailable="@OnMicAvailable" />
}

<Speaker @ref="@speaker" />

<div class="modern-chat-container">
    <!-- Header -->
    <div class="chat-header">
        <div class="chat-header-content">
            <div class="chat-title">
                <h1>ü§ñ Zava AI Assistant</h1>
                <p>Your intelligent companion for products and web content</p>
            </div>
            <div class="chat-actions">
                <button class="modern-btn @(isMicActive ? "btn-danger" : "btn-primary")" @onclick="ToggleMic">
                    @if (isMicActive)
                    {
                        <span class="btn-icon">üõë</span>
                        <span>Stop Voice Chat</span>
                    }
                    else
                    {
                        <span class="btn-icon">üé§</span>
                        <span>Start Voice Chat</span>
                    }
                </button>
                <button class="modern-btn btn-secondary" @onclick="ClearChat">
                    <span class="btn-icon">üóëÔ∏è</span>
                    <span>Clear Chat</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Messages Area -->
    <div class="chat-messages-container">
        <div class="chat-messages" @ref="chatMessagesContainer">
            @if (!chatMessages.Any())
            {
                <div class="welcome-message">
                    <div class="welcome-content">
                        <h3>üëã Welcome to Zava AI</h3>
                        <p>I can help you with:</p>
                        <ul>
                            <li>üõí Finding and recommending products</li>
                            <li>üìÑ Searching through indexed web content</li>
                            <li>üí¨ Answering questions using voice or text</li>
                            <li>üîç Providing detailed information with sources</li>
                        </ul>
                        <p><strong>Get started:</strong> Type a message below or click the voice chat button!</p>
                    </div>
                </div>
            }

            @foreach (var chatMessage in chatMessages)
            {
                <div class="message-wrapper @(chatMessage.IsUser ? "user-message" : "assistant-message")">
                    <div class="message-bubble">
                        <div class="message-header">
                            <div class="sender-avatar">
                                @if (chatMessage.IsUser)
                                {
                                    <span class="avatar user-avatar">üë§</span>
                                }
                                else
                                {
                                    <span class="avatar assistant-avatar">ü§ñ</span>
                                }
                            </div>
                            <div class="sender-info">
                                <span class="sender-name">@(chatMessage.IsUser ? "You" : "Zava AI")</span>
                                <span class="message-time">@chatMessage.Timestamp.ToString("HH:mm")</span>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(chatMessage.Message))
                        {
                            <div class="message-content">
                                @chatMessage.Message
                            </div>
                        }

                        @if (chatMessage.Products != null && chatMessage.Products.Any())
                        {
                            <div class="products-container">
                                <h4 class="content-header">üõí Product Recommendations</h4>
                                <div class="products-grid">
                                    @foreach (var product in chatMessage.Products)
                                    {
                                        <div class="modern-product-card">
                                            <div class="product-image-container">
                                                <img src="https://raw.githubusercontent.com/MicrosoftDocs/mslearn-dotnet-cloudnative/main/dotnet-docker/Products/wwwroot/images/@product.ImageUrl" 
                                                     alt="@product.Name" class="product-image" />
                                                <div class="product-price-badge">@product.Price.ToString("C")</div>
                                            </div>
                                            <div class="product-info">
                                                <h5 class="product-name">@product.Name</h5>
                                                <p class="product-description">@product.Description</p>
                                                <button class="modern-btn btn-outline-primary btn-sm">
                                                    <span class="btn-icon">üëÅÔ∏è</span>
                                                    <span>View Details</span>
                                                </button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @if (chatMessage.DataSourcesResponse != null && chatMessage.DataSourcesResponse.HasResults)
                        {
                            <div class="datasources-container">
                                <h4 class="content-header">üìÑ Web Sources (@chatMessage.DataSourcesResponse.SourceCount found)</h4>
                                <div class="sources-grid">
                                    @foreach (var source in chatMessage.DataSourcesResponse.SourcePages)
                                    {
                                        <div class="modern-source-card">
                                            <div class="source-header">
                                                <h6 class="source-title">@source.Title</h6>
                                                <div class="relevance-badge">
                                                    @((source.RelevanceScore * 100).ToString("F0"))% match
                                                </div>
                                            </div>
                                            <div class="source-content">
                                                <p class="source-excerpt">@source.Excerpt</p>
                                                <div class="source-footer">
                                                    <a href="@source.Url" target="_blank" class="source-link">
                                                        <span class="link-icon">üîó</span>
                                                        <span>@GetDomainFromUrl(source.Url)</span>
                                                    </a>
                                                    <small class="source-date">@source.IndexedAt.ToString("MMM dd, HH:mm")</small>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (isTyping)
            {
                <div class="message-wrapper assistant-message">
                    <div class="message-bubble typing-indicator">
                        <div class="message-header">
                            <div class="sender-avatar">
                                <span class="avatar assistant-avatar">ü§ñ</span>
                            </div>
                            <div class="sender-info">
                                <span class="sender-name">Zava AI</span>
                            </div>
                        </div>
                        <div class="typing-animation">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Text Input Area -->
    <div class="chat-input-container">
        <div class="input-wrapper">
            <textarea @bind="currentMessage" 
                      @onkeypress="OnKeyPress"
                      @oninput="OnInputChange"
                      placeholder="Type your message here... (Press Enter to send, Shift+Enter for new line)"
                      class="message-input"
                      rows="1"
                      disabled="@(isMicActive || isSending)"></textarea>
            <button class="send-button @(CanSendMessage() ? "active" : "")" 
                    @onclick="SendTextMessage" 
                    disabled="@(!CanSendMessage())">
                @if (isSending)
                {
                    <div class="spinner"></div>
                }
                else
                {
                    <span class="send-icon">‚û§</span>
                }
            </button>
        </div>
        <div class="input-footer">
            <small class="input-hint">
                @if (isMicActive)
                {
                    <span class="status-indicator active">üé§ Voice chat active - text input disabled</span>
                }
                else
                {
                    <span class="status-indicator">Press Enter to send ‚Ä¢ Shift+Enter for new line</span>
                }
            </small>
        </div>
    </div>
</div>

@code {
    private ConversationManager? conversationManager;
    private CancellationTokenSource disposalCts = new();
    private bool isMicActive = false;
    private bool isTyping = false;
    private bool isSending = false;
    private Speaker? speaker;
    private readonly List<RealtimeChatMessage> chatMessages = new();
    private ElementReference chatMessagesContainer;
    private string currentMessage = "";

    private void ToggleMic()
    {
        if (isMicActive)
        {
            // Stop interaction
            conversationManager?.Dispose();
            isMicActive = false;
        }
        else
        {
            // Start interaction
            disposalCts = new CancellationTokenSource();
            isMicActive = true;
        }
    }

    private void OnMicAvailable(PipeReader micReader)
    {
        var systemPrompt = SystemPromptService.GetCurrentPrompt();
        conversationManager = new(RealtimeClient, contosoProductContext, dataSourcesUrlContext, logger, SystemPromptService, systemPrompt);
        _ = RunAsBackgroundTask(() => conversationManager.RunAsync(micReader.AsStream(), speaker!,
            AddMessageAsync,
            AddChatMessageAsync,
            AddChatProductMessageAsync,
            AddChatDataSourcesMessageAsync,
            disposalCts.Token));
    }

    private async Task SendTextMessage()
    {
        if (!CanSendMessage()) return;

        var message = currentMessage.Trim();
        currentMessage = "";
        isSending = true;
        isTyping = true;

        // Add user message
        await AddChatMessageAsync(message, true);

        try
        {
            // Simulate processing delay
            await Task.Delay(500);
            
            // Here you would typically call your AI service
            // For now, we'll add a simple response
            await AddChatMessageAsync("Text chat functionality is being implemented. Please use voice chat for full functionality.", false);
        }
        finally
        {
            isSending = false;
            isTyping = false;
        }
    }

    private async Task OnKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendTextMessage();
        }
    }

    private void OnInputChange(ChangeEventArgs e)
    {
        currentMessage = e.Value?.ToString() ?? "";
    }

    private bool CanSendMessage()
    {
        return !string.IsNullOrWhiteSpace(currentMessage) && !isMicActive && !isSending;
    }

    private void ClearChat()
    {
        chatMessages.Clear();
        StateHasChanged();
    }

    private string GetDomainFromUrl(string url)
    {
        try
        {
            var uri = new Uri(url);
            return uri.Host;
        }
        catch
        {
            return url;
        }
    }

    public void Dispose()
    {
        disposalCts.Cancel();
        conversationManager?.Dispose();
    }

    private async Task AddChatMessageAsync(string message, bool isUserMessage)
    {
        var cm = new RealtimeChatMessage
        {
            Message = message,
            IsUser = isUserMessage,
            Timestamp = DateTime.Now
        };
        chatMessages.Add(cm);
        await InvokeAsync(StateHasChanged);
        await ScrollToBottom();
    }

    private async Task AddChatProductMessageAsync(List<Product> products)
    {
        var productMessage = new RealtimeChatMessage
        {
            IsUser = false,
            Products = products,
            Timestamp = DateTime.Now
        };
        chatMessages.Add(productMessage);
        await InvokeAsync(StateHasChanged);
        await ScrollToBottom();
    }

    private async Task AddChatDataSourcesMessageAsync(DataSourcesSearchResponse dataSourcesResponse)
    {
        var dataSourcesMessage = new RealtimeChatMessage
        {
            IsUser = false,
            Message = dataSourcesResponse.Response,
            DataSourcesResponse = dataSourcesResponse,
            Timestamp = DateTime.Now
        };
        chatMessages.Add(dataSourcesMessage);
        await InvokeAsync(StateHasChanged);
        await ScrollToBottom();
    }

    private async Task AddMessageAsync(string message)
    {
        // For debugging - could be removed in production
        logger.LogInformation("Debug message: {Message}", message);
    }

    private Task RunAsBackgroundTask(Func<Task> work)
    {
        return Task.Run(async () =>
        {
            try
            {
                await work();
            }
            catch (Exception ex) when (ex is not OperationCanceledException)
            {
                logger.LogError(ex, "Background realtime conversation failed");
            }
        });
    }

    private async Task ScrollToBottom()
    {
        await Task.Delay(50); // Small delay to ensure DOM is updated
        await JSRuntime.InvokeVoidAsync("scrollToBottom", chatMessagesContainer);
    }
}

<link rel="stylesheet" href="css/modern-chat.css" />